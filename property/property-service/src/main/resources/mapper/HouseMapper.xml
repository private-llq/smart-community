<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.jsy.community.mapper.HouseMapper">

	<!-- 查询下级house -->
	<select id="getSubIdList" parameterType="java.util.List" resultType="Long">
		select id from t_house
		where deleted = 0 and pid in
		<foreach collection="list" item="item" separator="," open="(" close=")">
			#{item}
		</foreach>
	</select>

	<!-- 添加次级房屋单位 -->
<!--	<insert id="addSub">-->
<!--		insert into t_house(id,code,community_id,building,unit,floor,door,pid,type,comment)-->
<!--		select #{houseEntity.id},#{houseEntity.code},community_id,-->
<!--		if(building != '',building,#{houseEntity.building}),-->
<!--		if(unit != '',unit,#{houseEntity.unit}),-->
<!--		if(floor != '',floor,#{houseEntity.floor}),-->
<!--		if(door != '',door,#{houseEntity.door}),-->
<!--		id,#{houseEntity.type},#{houseEntity.comment}-->
<!--		from t_house-->
<!--		where id = #{houseEntity.pid}-->
<!--	</insert>-->
	<!-- 按社区id获取社区名称 和社区 房间数量 -->
	<select id="getCommunityNameAndUserAmountById"  resultType="java.util.HashMap">
		select c.name,(SELECT count(*) from t_house where community_id = c.id and type = 4) as communityUserNum from t_community as c where  c.deleted = 0 and c.id = #{communityId}
	</select>

	<!-- 按社区ID获取 社区名称 社区用户名和社区-->
	<select id="getCommunityNameAndUserInfo"  resultMap="useNameInfoMap">
		select DISTINCT u.real_name,u.uid,c.name from t_user as u left join t_user_house as h on u.uid = h.uid JOIN t_community as c on h.community_id = c.id where u.deleted = 0 and h.deleted = 0 and c.deleted = 0 and h.community_id = #{communityId}
	</select>
	<resultMap id="useNameInfoMap" type="com.jsy.community.entity.UserEntity">
		<result column="real_name" property="realName"/>
		<result column="uid" property="uid"/>
		<!--由于实体字段信息并不会返回到前端，所以我这里直接用UserEntity的nickname字段来封装 社区名称-->
		<result column="name" property="nickname"/>
	</resultMap>

	<!-- 通过社区ID查出所有 楼栋、单元、楼层、门牌、作为excel 下拉选择字符串 -->
	<select id="getCommunityArchitecture" resultType="com.jsy.community.entity.HouseEntity">
		SELECT DISTINCT
			h.building,
			h.unit,
			h.floor,
			h.door,
			h.id
		FROM
			t_house AS h
		LEFT JOIN t_user_house AS uh ON h.id = uh.house_id and uh.deleted = 0
		WHERE
			uh.id IS NULL
		AND h.deleted = 0
		AND h.community_id = #{communityId}
	</select>

	<!-- ============================================ 物业端产品原型确定后新加的 开始  =========================================================== -->
	<!-- 批量更新单元到楼栋节点下 -->
	<update id="unitBindBuilding">
		update t_house
		set pid = #{entity.id}, building = #{entity.building}
		where id in
		<foreach collection="list" item="item" separator="," open="(" close=")">
			#{item}
		</foreach>
	</update>

	<!-- 添加房屋 -->
	<insert id="addRoom">
		insert into t_house(id,code,community_id,number,build_area,house_type_code,house_type,property_type,building,unit,floor,door,pid,type,comment)
		select #{houseEntity.id},#{houseEntity.code},community_id,#{houseEntity.number},#{houseEntity.buildArea},#{houseEntity.houseTypeCode},#{houseEntity.houseType},#{houseEntity.propertyType},
		if(building != '',building,#{houseEntity.building}),
		if(unit != '',unit,#{houseEntity.unit}),
		#{houseEntity.floor},
		if(door != '',door,#{houseEntity.door}),
		id,#{houseEntity.type},#{houseEntity.comment}
		from t_house
		where id = #{houseEntity.pid}
	</insert>

	<!-- 批量更新次级节点冗余的父级名称 -->
	<update id="updateSub">
		update t_house
		<set>
			<if test="entity.building != null and entity.building != ''">,building = #{entity.building}</if>
			<if test="entity.unit != null and entity.unit != ''">,unit = #{entity.unit}</if>
			where id in
			<foreach collection="list" item="item" separator="," open="(" close=")">
				#{item}
			</foreach>
		</set>
	</update>

	<!-- 更新修改 -->
	<update id="updateHouse">
		update t_house h
		<set>
			<if test="entity.number != null and entity.number != ''">,h.number = #{entity.number}</if>
			<if test="entity.buildArea != null and entity.buildArea != 0">,h.build_area = #{entity.buildArea}</if>
			<if test="entity.totalFloor != null and entity.totalFloor != 0">,h.total_floor = #{entity.totalFloor}</if>
			<if test="entity.hasElevator != null and entity.hasElevator != 0">,h.has_elevator = #{entity.hasElevator}</if>
			<if test="entity.building != null and entity.building != ''">,h.building = #{entity.building}</if>
			<if test="entity.unit != null and entity.unit != ''">,h.unit = #{entity.unit}</if>
			<if test="entity.door != null and entity.door != ''">,h.door = #{entity.door}</if>
			<if test="entity.pid != null and entity.pid != 0">,h.pid = #{entity.pid}</if>
			<if test="entity.houseTypeCode != null and entity.houseTypeCode != ''">,h.house_type_code = #{entity.houseTypeCode}</if>
			<if test="entity.houseType != null and entity.houseType != 0">,h.house_type = #{entity.houseType}</if>
			<if test="entity.propertyType != null and entity.propertyType != 0">,h.property_type = #{entity.propertyType}</if>
			<if test="entity.decoration != null and entity.decoration != 0">,h.decoration = #{entity.decoration}</if>
			<if test="entity.floor != null and entity.floor != ''">,h.floor = #{entity.floor}</if>
			,update_time = now()
		</set>
		where id = #{entity.id}
	</update>

	<!-- 批量查询楼栋已绑定单元数 -->
	<select id="queryBindUnitCountBatch" resultType="Map">
		select pid,count(0) as count from t_house where type = 2 and pid in
		<foreach collection="list" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
		group by pid
	</select>
	<!-- ============================================ 物业端产品原型确定后新加的 结束  =========================================================== -->
</mapper>
